<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Main - Sanjivan Medico Traders</title>
	<link rel="stylesheet" href="styles.css" />
	<style>
		/* Basic styles for header */
		body {
			font-family: Arial, sans-serif;
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		header {
			background-color: #333;
			color: white;
			padding: 10px 20px;
			text-align: center;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		header h1 {
			margin: 0;
		}

		#logout-btn {
			background-color: #f44336;
			color: white;
			border: none;
			padding: 10px;
			cursor: pointer;
		}

		#logout-btn:hover {
			background-color: #d32f2f;
		}

		/* Styling for the main container */
		.container {
			padding: 20px;
		}

		h2 {
			font-size: 24px;
			margin-bottom: 20px;
		}

		/* Table styling */
		table {
			width: 100%;
			border-collapse: collapse;
			margin-bottom: 20px;
		}

		th,
		td {
			padding: 10px;
			border: 1px solid #ddd;
			text-align: center;
		}

		th {
			background-color: #f4f4f4;
		}

		input {
			width: 100%;
			padding: 8px;
			margin: 5px 0;
			box-sizing: border-box;
			border: 1px solid #ccc;
			border-radius: 4px;
		}

		input:focus {
			border-color: #4caf50;
		}

		#add-button {
			background-color: #4caf50;
			color: white;
			border: none;
			padding: 10px;
			cursor: pointer;
		}

		#add-button:hover {
			background-color: #45a049;
		}

		/* Fixing the width of the columns */
		td,
		th {
			width: 10%;
		}

		/* Ensuring the fields don't overflow */
		input[type="text"],
		input[type="number"],
		input[type="date"] {
			width: calc(100% - 20px);
		}

		/* Styling for error */
		input.error {
			border: 2px solid red;
		}

		/* Adding responsiveness */
		@media (max-width: 768px) {

			table,
			th,
			td {
				font-size: 12px;
			}

			input {
				width: 100%;
			}
		}

		.delete-btn {
			background-color: #f44336;
			color: white;
			border: none;
			padding: 5px 10px;
			cursor: pointer;
		}

		.delete-btn:hover {
			background-color: #d32f2f;
		}
	</style>
</head>

<body>
	<header style="color: #45a049">
		<h1>Sanjivan Medico Traders</h1>
		<button id="logout-btn">Logout</button>
	</header>
	<div class="container">
		<h2>Add Record</h2>
		<table id="add-table">
			<thead>
				<tr>
					<th>Sr. No.</th>
					<th>Date</th>
					<th>Party Code</th>
					<th>Medical Name</th>
					<th>City</th>
					<th>Receipt No.</th>
					<th>Amount</th>
					<th>Remarks</th>
					<th>Action</th>
				</tr>
			</thead>
			<tbody id="add-row">
				<tr>
					<td>1</td>
					<td><input type="date" id="date" required onchange="dateChange()" /></td>
					<td>
						<input type="text" id="party-code" placeholder="Party Code" oninput="filterDropDown()"
							required />
						<select id="dropdownSelect" oninput="selectPartyCode()">
						</select>
					</td>
					<td>
						<input type="text" id="medical-name" placeholder="Medical Name" required disabled />
					</td>
					<td><input type="text" id="city" placeholder="City" required disabled /></td>
					<td>
						<input type="text" id="receipt-no" placeholder="Receipt No." required />
					</td>
					<td>
						<input type="number" id="amount" placeholder="Amount" required />
					</td>
					<td><input type="text" id="remarks" placeholder="Remarks" /></td>
					<td><button id="add-button">Add</button></td>
				</tr>
			</tbody>
		</table>

		<h2>Record History</h2>
		<table id="history-table">
			<thead>
				<tr>
					<th>Sr. No.</th>
					<th>Date</th>
					<th>Party Code</th>
					<th>Medical Name</th>
					<th>City</th>
					<th>Receipt No.</th>
					<th>Amount</th>
					<th>Remarks</th>
					<th>Action</th>
				</tr>
			</thead>
			<tbody id="history-body">
				<!-- Records will appear here -->
			</tbody>
		</table>
	</div>

	<script>
		const today = new Date();
		const formattedDate = today.toISOString().split('T')[0];
		// Set the value of the input field
		document.getElementById('date').value = formattedDate

		let recordCount = 1;

		// Selection box js
		var allOptions = [];
		async function filterDropDown() {
			const searchText = document.getElementById("party-code").value.toLowerCase();
			let options = [];
			for (let i = 0; i < allOptions.length; i++) {
				const optionText = allOptions[i].CODE.toLowerCase();
				if (optionText.indexOf(searchText) > -1) {
					options.push(allOptions[i]);
				}
			}
			updateOption(options);
		}
		function updateOption(options) {
			let dropDown = document.getElementById('dropdownSelect');
			let currOptions = ``;
			options.forEach((val, i) => {
				currOptions +=
					`
            <option value="${val.CODE}">${val.CODE}</option>
          `
			})
			dropDown.innerHTML = currOptions;
			selectPartyCode();
		}
		async function loadPartyCodes() {
			try {
				const response = await fetch('./partycode.json'); // Fetch the JSON file
				const data = await response.json(); // Parse JSON content
				allOptions = data;
				updateOption(allOptions);
			} catch (error) {
				alert(error);
			}
		}
		loadPartyCodes();
		function selectPartyCode() {
			let currSelection = document.getElementById('dropdownSelect').value;
			if (currSelection !== '') {
				let optionArr = allOptions.filter((val) => {
					return currSelection === val.CODE;
				})
				document.getElementById('medical-name').value = optionArr[0]['CUSTOMER NAME']
				document.getElementById('city').value = optionArr[0]['City']
			}
		}


		document
			.getElementById("add-button")
			.addEventListener("click", async function () {
				const date = document.getElementById("date");
				const partyCode = document.getElementById("dropdownSelect");
				const medicalName = document.getElementById("medical-name");
				const city = document.getElementById("city");
				const receiptNo = document.getElementById("receipt-no");
				const amount = document.getElementById("amount");
				const remarks = document.getElementById("remarks");

				const fields = [
					date,
					partyCode,
					medicalName,
					city,
					receiptNo,
					amount,
				];
				let isValid = true;

				// Validation
				fields.forEach((field) => {
					if (!field.value.trim()) {
						field.classList.add("error");
						isValid = false;
					} else {
						field.classList.remove("error");
					}
				});

				if (!isValid) {
					alert("Please fill out all required fields.");
					return;
				}
				try {

					let record = {
						track: "",
						drivername: "",
						date: date.value,
						salesman: JSON.parse(localStorage.getItem('user')).name,
						receiptNumber: receiptNo.value,
						amount: amount.value,
						city: city.value,
						remark: remarks.value,
						name: medicalName.value,
						partyCode: partyCode.value,
						token: (localStorage.getItem('jwt'))
					};


					const response = await fetch('/api/code/save-record', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify(record),
					});

					let data = await response.json();
					// Clear Input Fields
					document.querySelectorAll("#add-row input").forEach((input) => {
						if (input.id === 'receipt-no' || input.id === 'amount') {
							input.value = "";
						}
						input.classList.remove("error"); // Remove error class after clearing
					});
					updateRecordList();
				} catch (error) {
					alert(error)
				}
			});

		async function dateChange() {
			updateRecordList();
		}
		async function updateRecordList() {
			const tableBody = document.getElementById("history-body");
			tableBody.innerHTML = '';
			try {
				let dateValue = document.getElementById('date').value;
				const start = new Date(dateValue);
				start.setUTCHours(0, 0, 0, 0); // Start of the day in UTC
				const end = new Date(dateValue);
				end.setUTCHours(23, 59, 59, 999); // End of the day in UTC

				let record = {
					salesman: JSON.parse(localStorage.getItem('user')).name,
					start, end,
					token: (localStorage.getItem('jwt'))
				};


				const response = await fetch('/api/code/filter-records', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(record),
				});

				let allRecords = await response.json();
				console.log(allRecords);

				allRecords.forEach((record, i) => {
					const row = document.createElement("tr");
					row.innerHTML = `
					<td>${i + 1}</td>
					<td>${record.date}</td>
					<td>${record.partyCode}</td>
					<td>${record.name}</td>
					<td>${record.city}</td>
					<td>${record.receiptNumber}</td>
					<td>${record.amount}</td>
					<td>${record.remark}</td>
					<td><button class="delete-btn">Delete</button></td>
					`;

					tableBody.appendChild(row);

					// Add delete functionality
					row
						.querySelector(".delete-btn")
						.addEventListener("click", async function (event) {
							if (
								confirm(
									"Are you sure you want to delete this record? This action is irreversible."
								) &&
								confirm("Please confirm again to delete.")

							) {
								try {
									record.token = localStorage.getItem('jwt');
									const response = await fetch('/api/code/delete-records', {
										method: 'POST',
										headers: {
											'Content-Type': 'application/json',
										},
										body: JSON.stringify(record),
									});

									await response.json();
									updateRecordList();
								} catch (error) {
									console.log(error);
									alert(error);
								}
							}
						});

				})

			} catch (error) {
				console.log(error);
			}
		}
		updateRecordList();
		document
			.getElementById("logout-btn")
			.addEventListener("click", function () {
				window.location.href = "../index.html"; // Redirect to the login page
			});
	</script>
</body>

</html>